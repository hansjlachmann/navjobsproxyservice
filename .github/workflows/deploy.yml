name: Build, Test and Deploy NavJobsProxyService

on:
  ##push:
  ##  branches:
  ##    - master
  pull_request:
    branches:
      - master

jobs:
  build:
    name: Build
    runs-on: [self-hosted, Windows, nav-proxy-webservice]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Publish
        run: dotnet publish NavJobsProxyService/NavJobsProxyService.csproj -c Release -o ${{ runner.temp }}/publish

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: publish-output
          path: ${{ runner.temp }}/publish
          retention-days: 1

  test:
    name: Test
    runs-on: [self-hosted, Windows, nav-proxy-webservice]
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Run Tests
        run: dotnet test --configuration Release --no-build --verbosity normal

  deploy:
    name: Deploy
    runs-on: [self-hosted, Windows, nav-proxy-webservice]
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: publish-output
          path: ${{ runner.temp }}/publish

      - name: Stop Service
        run: |
          $service = Get-Service -Name "NavJobsProxyService" -ErrorAction SilentlyContinue
          if ($service -and $service.Status -eq 'Running') {
            Stop-Service -Name "NavJobsProxyService" -Force
            Start-Sleep -Seconds 2
          }
        shell: powershell

      - name: Deploy files
        run: |
          $source = "${{ runner.temp }}/publish/*"
          $destination = "C:\NavJobsProxyService"

          if (!(Test-Path $destination)) {
            New-Item -ItemType Directory -Path $destination -Force
          }

          Copy-Item -Path $source -Destination $destination -Recurse -Force
        shell: powershell

      - name: Start Service
        run: |
          Start-Service -Name "NavJobsProxyService"
          Start-Sleep -Seconds 2
          $service = Get-Service -Name "NavJobsProxyService"
          Write-Host "Service status: $($service.Status)"
        shell: powershell
